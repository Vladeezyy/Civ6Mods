--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
-- INCLUDES
--==========================================================================================================================

--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
print("Monopoly+ Warehouse scripts loaded")
--==========================================================================================================================
-- Variables
--==========================================================================================================================

local iProperty = "Leu_Warehouse_Has_"
local iImprovement = "IMPROVEMENT_LEU_WAREHOUSE"
local iNavalImprovement = "IMPROVEMENT_LEU_CONTAINER_PORT"
-- Values







--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
-- UTILITY FUNCTIONS
--==========================================================================================================================
-- UTILS
----------------------------------------------------------------------------------------------------------------------------

--==========================================================================================================================
-- CORE FUNCTIONS
--==========================================================================================================================
-- Valid Resource obtaining
tLuxuries = {}
for row in GameInfo.Resources() do
	local iResourceType = row.ResourceType
	local iResourceClass = row.ResourceClassType
	if iResourceClass == 'RESOURCECLASS_LUXURY' then
		tLuxuries[iResourceType] = true
	end
end


bMonopoliesActive = false
tValidLuxury = {}
for row in GameInfo.GameCapabilities() do
	if row.GameCapability == 'CAPABILITY_MONOPOLIES' then
		bMonopoliesActive = true
	end
end
if bMonopoliesActive == true then
	for row in GameInfo.Improvement_ValidResources() do
		local iResourceType = row.ResourceType
		local iImprovementType = row.ImprovementType
		--print(iIsWonder)
		for iResourceTypeStr in pairs(tLuxuries) do
			if iResourceType == iResourceTypeStr then
				--print(iResourceType .. " is being added to our Luxuries database")
				tValidLuxury[iResourceType] = true
			end
		end
	end
end


function Leu_Warehouse_ImprovementCreated(iX, iY, iImprovementType, iOwner)
	if iImprovementType == GameInfo.Improvements["" .. iImprovement .. ""].Index or iImprovementType == GameInfo.Improvements["" .. iNavalImprovement .. ""].Index then
		print("Valid improvement Created")
		local iPlot = Map.GetPlot(iX, iY)
		if iPlot:GetResourceType() == -1 then
			--Check for Luxuries
			for direction = 0, DirectionTypes.NUM_DIRECTION_TYPES - 1, 1 do
				local adjacentPlot = Map.GetAdjacentPlot(iX, iY, direction);
				if adjacentPlot and not adjacentPlot:IsCity() then
					adjResource = adjacentPlot:GetResourceType()
					for iResourceTypeStr in pairs(tValidLuxury) do
						--print("Checking if the plot has a" ..  iResourceTypeStr)
						if adjResource == GameInfo.Resources[iResourceTypeStr].Index then
							iPropertyToAssign = "" .. iProperty .. iResourceTypeStr .. ""
							print("The property to assign is " .. iPropertyToAssign .. "")
							iPlot:SetProperty(iPropertyToAssign, 1)
						end
					end
				end
			end
		end
	end
end


function Leu_Warehouse_ImprovementRemoved (iX, iY, iOwner)
	local iPlot = Map.GetPlot(iX, iY);
	for iResourceTypeStr in pairs(tValidLuxury) do
		iPropertyToAssign = "" .. iProperty .. iResourceTypeStr .. ""
		--print("The property to remove is " .. iPropertyToAssign .. "")
		iPlot:SetProperty(iPropertyToAssign, 0)
	end
end
	
if bMonopoliesActive == true then
	Events.ImprovementAddedToMap.Add(Leu_Warehouse_ImprovementCreated);
	Events.ImprovementRemovedFromMap.Add(Leu_Warehouse_ImprovementRemoved);
end

--==========================================================================================================================
--==========================================================================================================================