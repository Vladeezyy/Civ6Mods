--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
-- INCLUDES
--==========================================================================================================================

--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
print("Jebel Barkal Rework UI Functions Loaded")
--==========================================================================================================================
-- Variables
--==========================================================================================================================












--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
--<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
--==========================================================================================================================
--==========================================================================================================================
-- UTILITY FUNCTIONS
--==========================================================================================================================
-- UTILS
----------------------------------------------------------------------------------------------------------------------------
iMod = (GameInfo.GameSpeeds[GameConfiguration.GetGameSpeedType()].CostMultiplier)/100;


--==========================================================================================================================
-- CORE FUNCTIONS
--==========================================================================================================================
function Leu_CheckTradingWithJebel(playerID)
	local pPlayer = Players[playerID]
	if pPlayer == nil then return end
	local numJebelBarkers	= 0
	local iCityX			= 0;
	local iCityY			= 0;
	local playerCities = pPlayer:GetCities()
		for _, pCity in playerCities:Members() do
			if pCity ~= nil then
				pCityX = pCity:GetX();
				pCityY = pCity:GetY();
				local pPlot = Map.GetPlot(pCityX, pCityY);
				if pPlot:GetProperty("LeuHasJebelBarkal") == 1 then
					iCityX = pCityX;
					iCityY = pCityY;
				end

				local tOutgoingRoutes = pCity:GetTrade():GetOutgoingRoutes()
				for _, tRoute in ipairs(tOutgoingRoutes) do
					local destinationPlayer:table = Players[tRoute.DestinationCityPlayer];
					if destinationPlayer == pPlayer then
						-- the trade route is local
						-- and now check if the destination city has JebelBarkal
						local destinationCity = destinationPlayer:GetCities():FindID(tRoute.DestinationCityID);
						local dCityX = destinationCity:GetX();
						local dCityY = destinationCity:GetY();
						local dPlot = Map.GetPlot(dCityX, dCityY);
						if dPlot:GetProperty("LeuHasJebelBarkal") == 1 then numJebelBarkers = numJebelBarkers + 1 end
						--
					end
				end
			end
		end
	
	local iPlot = Map.GetPlot(iCityX, iCityY);
	local currentProperty = iPlot:GetProperty("LeuJebelBarkal_NumDomestics")
	if currentProperty == nil or currentProperty ~=  numJebelBarkers then
			-----------------------------------------
			-- Parameters ---------------------------
			-----------------------------------------
			local parameters = {}
				parameters.playerID = playerID;
				parameters.Leu_CityX = iCityX;
				parameters.Leu_CityY = iCityY;
				parameters.Leu_NumDomesticRoutes = numJebelBarkers

				parameters.OnStart = "Leu_CheckJebelBarkalDomesticRoutes";
				UI.RequestPlayerOperation(playerID, PlayerOperations.EXECUTE_SCRIPT, parameters);
	end
end
			

Events.PlayerTurnActivated.Add(Leu_CheckTradingWithJebel);
Events.TradeRouteActivityChanged.Add(Leu_CheckTradingWithJebel);
--GameEvents.BuildingConstructed.Add(Leu_CheckTradingWithJebel);